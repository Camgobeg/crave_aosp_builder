name: Android ROM Build

on:
  workflow_dispatch:
    inputs:
      BASE_PROJECT:
        description: 'Choose a base project:'
        required: true
        default: 'LineageOS 21.0'
        type: choice
        options:
          - 'LineageOS 20.0'
          - 'LineageOS 21.0'
          - 'LineageOS 22.0'
          - 'LineageOS 23.1'
          - 'ArrowOS 13.1'
          - 'DerpFest 14.0'
          - 'CipherOS 14'
          - 'PixelOS 14'
          - 'RisingOS 14'
          - 'AOSP'

      PRODUCT_NAME:
        description: 'Device codename (example: spes)'
        required: true
        default: 'spes'

      BUILD_TYPE:
        description: 'Build type'
        required: true
        default: 'userdebug'
        type: choice
        options:
          - user
          - userdebug
          - eng

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop openjdk-17-jdk pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev

    - name: Set Project variables
      run: |
        case "${{ github.event.inputs.BASE_PROJECT }}" in

          "LineageOS 20.0")
            PROJECTFOLDER="$HOME/Lineage20"
            REPO_INIT="repo init -u https://github.com/LineageOS/android.git -b lineage-20.0 --depth=1"
          ;;

          "LineageOS 21.0")
            PROJECTFOLDER="$HOME/Lineage21"
            REPO_INIT="repo init -u https://github.com/LineageOS/android.git -b lineage-21.0 --depth=1"
          ;;

          "LineageOS 22.0")
            PROJECTFOLDER="$HOME/Lineage22"
            REPO_INIT="repo init -u https://github.com/LineageOS/android.git -b lineage-22.0 --depth=1"
          ;;

          "LineageOS 23.1")
            PROJECTFOLDER="$HOME/Lineage23"
            REPO_INIT="repo init -u https://github.com/LineageOS/android.git -b lineage-23.1 --depth=1"
          ;;

          "AOSP")
            PROJECTFOLDER="$HOME/AOSP"
            REPO_INIT="repo init -u https://android.googlesource.com/platform/manifest -b android-15.0.0_r1 --depth=1"
          ;;

        esac

        echo "PROJECTFOLDER=$PROJECTFOLDER" >> $GITHUB_ENV
        echo "REPO_INIT=$REPO_INIT" >> $GITHUB_ENV

    - name: Init repo
      run: |
        mkdir -p $PROJECTFOLDER
        cd $PROJECTFOLDER
        $REPO_INIT

    - name: Repo sync
      run: |
        cd $PROJECTFOLDER
        repo sync -c --force-sync --no-clone-bundle --no-tags -j$(nproc)

    - name: Setup ccache
      run: |
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 50G

    - name: Build ROM
      run: |
        cd $PROJECTFOLDER
        source build/envsetup.sh

        breakfast ${{ github.event.inputs.PRODUCT_NAME }} ${{ github.event.inputs.BUILD_TYPE }}

        mka bacon -j$(nproc)

    - name: Upload build
      uses: actions/upload-artifact@v4
      with:
        name: ROM
        path: |
          ${{ env.PROJECTFOLDER }}/out/target/product/**/**/*.zip
